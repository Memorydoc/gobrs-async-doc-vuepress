---
title: ğŸ…åŠ¨æ€ä»»åŠ¡ 
date: 2020-05-11 13:54:56 
permalink: /pages/2f844c
article: false
---

## å¦‚ä½•å¼€å‘ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡

::: warning å°æç¤º
çœ‹åˆ°è¿™é‡Œï¼Œå°ä¼™ä¼´ä»¬æ˜¯ä¸æ˜¯å·²ç»è¿«ä¸åŠå¾…çš„æƒ³çœŸæ­£çš„ä½“éªŒä¸€ä¸‹ <code>**Gobrs-Async**</code> æ˜¯æ€æ ·å¼€å‘ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„ã€‚ é‚£ä¹ˆä¸‹é¢ç”±æˆ‘å¸¦é¢†å¤§å®¶æ¥æ„Ÿå—ä¸€ä¸‹ ä¸€ä¸ªå®Œæ•´çš„ 
<code>**AsyncTask**</code> éœ€è¦æ€ä¹ˆå¼€å‘ã€‚
:::

## æ™®é€šä»»åŠ¡
## åˆ›å»º Bean ç»§æ‰¿ AsyncTask

> è¿™é‡Œ AsyncTask<T, V> æ˜¯ä¸€ä¸ªæ³›å‹æ¥å£

* T ä»£è¡¨ ä»»åŠ¡çš„å‚æ•°ç±»å‹
* V ä»£è¡¨ ä»»åŠ¡çš„è¿”å›ç±»å‹

å¦‚ä¸‹ï¼š

```java 
/**
 * @program: gobrs-async
 * @ClassName TaskBean
 * @description: å¼‚æ­¥ä»»åŠ¡ ä»»åŠ¡å‚æ•° Objectç±»å‹ ; ä»»åŠ¡è¿”å› Objectç±»å‹
 **/
@Component
public class BService extends AsyncTask<Object, Object> {

    @Override
    public void prepare(Object o) {

    }

    @Override
    public Object task(Object o, TaskSupport support) {
        String result = getResult(support, AService.class);
        System.out.println("æ‹¿åˆ°çš„ç»“æœ" + result);
        System.out.println("æ‰§è¡ŒBService");
        return null;
    }

    @Override
    public boolean nessary(Object o, TaskSupport support) {
        return true;
    }

    @Override
    public void onSuccess(TaskSupport support) {

    }

    @Override
    public void onFail(TaskSupport support) {

    }
}

```
### æ ¸å¿ƒä»»åŠ¡æ‰§è¡Œ

æ ¸å¿ƒä»»åŠ¡ä¸ºä½¿ç”¨è€…æœ€ä¸ºå…³æ³¨çš„åŠŸèƒ½æ–¹æ³•ï¼Œéœ€è¦å¼€å‘RPCã€HTTPã€IO ç­‰æ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ä¸šåŠ¡é€»è¾‘ã€‚
```java 
@Override
public Object task(Object o, TaskSupport support) {
    // todo ä¸šåŠ¡é€»è¾‘
    return null;
}
```


### è·å–ä¾èµ–çš„ä»»åŠ¡ç»“æœ
**Gobrs-Async** æä¾›äº† <code>getResult</code> æ–¹æ³•ï¼Œæ— éœ€ç”¨æˆ·å…³æ³¨å¦‚ä½•è·å–åˆ°çš„ä¾èµ–ç»“æœï¼Œåªéœ€è¦æŒ‰ç…§ä½¿ç”¨æ–¹å¼ä¾¿å¯è½»æ¾è·å–æ‰€éœ€ç»“æœå€¼
```java
@Override
public Object task(Object o, TaskSupport support) {
    // æ‹¿åˆ° AService (ä»»åŠ¡bean) è¿”å›çš„ç»“æœï¼Œ ç»“æœç±»å‹ä¸ºStringç±»å‹
    String result = getResult(support, AService.class, String.class);
    
    return null;
}
```
<code>getResult</code> æœ‰ä¸‰ä¸ªå‚æ•°
* TaskSupport ï¼š **Gobrs-Async** æ‰€éœ€è¦çš„æ ¸å¿ƒå‚æ•°ï¼Œé€šè¿‡ <code>task</code> æ–¹æ³•ä¸­çš„å‚æ•°é€ç©¿å³å¯
* Class: æ‰€ä¾èµ–çš„ Beançš„ Java ç±»å‹
* Class: è¿”å›ç»“æœçš„ç±»å‹ 


### ä»»åŠ¡æ˜¯å¦æ‰§è¡Œ

**Gobrs-Async**  ä¼šæ ¹æ® <code>nessary</code>  çš„è¿”å›ç»“æœï¼Œåˆ¤æ–­å½“å‰<code>task</code> æ˜¯å¦éœ€è¦æ‰§è¡Œ å¦‚æœè¿”å›<code>true</code> åˆ™éœ€è¦è¢«æ‰§è¡Œï¼Œå¦åˆ™è¿”ä¹‹ã€‚

ä¾‹å¦‚ï¼š å½“å‚æ•°ä¸º <code>cancel</code> æ—¶ï¼Œ ä»»åŠ¡ä¸æ‰§è¡Œã€‚

```java 
@Override
public boolean nessary(String params, TaskSupport support) {
     // å‡å¦‚å‚æ•°æ˜¯cancel åˆ™ä¸æ‰§è¡Œå½“å‰ä»»åŠ¡
    if("cancel".equals(params)){
        return false;
    }
    return true;
}
```

### ä»»åŠ¡æˆåŠŸå›è°ƒ

å¦‚æœä½ æƒ³åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆååšä¸€äº›é¢å¤–çš„æ“ä½œã€‚ä¾‹å¦‚æ‰“å°æ—¥å¿—ã€å‘é€é‚®ä»¶ã€å‘é€MQã€è®°å½•ä¿¡æ¯ç­‰ã€‚ **Gobrs-Async**  åŒæ ·ä¹Ÿä¸ºä½ è€ƒè™‘åˆ°äº†ã€‚é€šè¿‡å®ç° callback æ–¹æ³•ã€‚ä¼šè®©ä½ è½»æ¾çš„æ‹¿åˆ°
ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚

```java 
@Override
public void onSuccess(TaskSupport support) {
    // todo ä»»åŠ¡æˆåŠŸé€»è¾‘
}
```

### ä»»åŠ¡å¤±è´¥å›è°ƒ
åœ¨ä»»åŠ¡å¼‚å¸¸æ—¶å‘é€å‘Šè­¦ä¿¡æ¯
```java
@Override
public void onFail(TaskSupport support) {
    // todo  ä»»åŠ¡æ‰§è¡Œå¤±è´¥å›è°ƒé€»è¾‘
}
```

### ä»»åŠ¡æ ‡è¯†
å¦‚æœä½ æƒ³å¯¹ ä»»åŠ¡è¿›è¡Œå…¨å±€æ‹¦æˆª æ­¤æ—¶å°±éœ€è¦å¯¹æ¯ä¸€ä¸ªä»»åŠ¡åŠ ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è¯†ï¼Œè¿™æ ·åœ¨åšå…¨å±€æ‹¦æˆªçš„æ—¶å€™ï¼Œå°±å¯ä»¥åŒºåˆ†ä¸åŒçš„ä»»åŠ¡ï¼Œä»è€Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚æˆ–è€…è¿›è¡Œä¸åŒçš„æ—¥å¿—æ‰“å°
MQã€é“¾è·¯ç›‘æ§ç­‰ç­‰ã€‚ é‚£ä¹ˆ **Gobrs-Async** ä¸ºä½ æä¾›äº†æ”¯æŒã€‚ åªéœ€è¦åœ¨ ä»»åŠ¡ <code>Bean</code> ä¸­åŠ ä¸Šæ³¨è§£ï¼Œ åˆ™ä¼šå‘ŠçŸ¥æ¡†æ¶æ­¤ ä»»åŠ¡çš„åç§°
å³ [å…¨å±€ä»»åŠ¡æ‹¦æˆª](/pages/2f84sf/#å¯é…ç½®çš„å…¨å±€ä»»åŠ¡æ‹¦æˆªå™¨) ï¼Œå…¶ä¸­ æ³¨è§£ä¸­çš„ name å€¼å¯¹åº”çš„å°±æ˜¯å…¨å±€æ‹¦æˆªå™¨ä¸­å‚æ•°ä¸­çš„ <code>taskName</code>

```java 
@Task(name = "itemTask")
```

## é‡è¯•ä»»åŠ¡
æ‰§è¡Œä¸­çš„ä»»åŠ¡ä¼šå‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œå¦‚æœä½¿ç”¨è€…æœ‰å¯¹ä»»åŠ¡å¤±è´¥é‡è¯•çš„éœ€æ±‚ï¼Œ**Gobrs-Async** ä¹Ÿä¸ºä½ æä¾›äº†æ”¯æŒ,åªéœ€è¦åœ¨ éœ€è¦å¼€å¯é‡è¯•çš„ä»»åŠ¡ <code>bean</code>
ä¸­ä½¿ç”¨ <code>@Task(retryCount = 10)</code> æ³¨è§£ï¼Œæ¡†æ¶åˆ™è‡ªåŠ¨ä¼šä¸ºä½ å¼€å¯é‡è¯•æ¨¡å¼ã€‚ <code>retryCount</code> æ‰€è·Ÿçš„æ•°å­—ä¸º **é‡è¯•æ¬¡æ•°**
```java 
@Component
@Task(retryCount = 10)
public class BService extends AsyncTask<Object, Object>  {
// ...
}
```


## äº‹åŠ¡ä»»åŠ¡
ä½¿ç”¨è€…å¯èƒ½æœ‰è¿™ç§äº‹åŠ¡éœ€æ±‚çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚ A -> B -> C çš„åœºæ™¯ï¼Œå¦‚æœCæ‰§è¡Œå¤±è´¥äº†ï¼Œ åˆ™é€šçŸ¥ Aå’ŒB ä»»åŠ¡è¿›è¡Œä¸šåŠ¡å›æ»šã€‚ åˆ™è¿™ç§æ–¹å¼ **Gobrs-Async** ä¹Ÿæ˜¯æ”¯æŒçš„
äº‹åŠ¡ä»»åŠ¡ä¹Ÿéœ€è¦ç»§æ‰¿ <code>AsyncTask</code>, å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ã€‚

åªéœ€è¦åœ¨<code>application.yml</code>ä¸­é…ç½®
### application.yml é…ç½®

```yaml
spring:
  gobrs:
    async:
      transaction: true
```
### é‡å†™é»˜è®¤rollbackæ–¹æ³•
```java 
//  äº‹åŠ¡å›æ»š å…·ä½“å›æ»šä¸šåŠ¡éœ€è¦è‡ªå·±å®ç° è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé»˜è®¤æ–¹æ³• éœ€è¦è‡ªå·±æ‰‹åŠ¨é‡å†™
@Override
public void rollback(DataContext dataContext) {
    //super.rollback(dataContext);
    //todo rollback business
}
```

### æ³¨è§£å£°æ˜
åœ¨ä½ éœ€è¦è¿›è¡Œäº‹åŠ¡çš„ä»»åŠ¡ä¸Šè¿›è¡Œå›æ»šæ³¨è§£ï¼Œ **Gobrs-Async** ä¼šæ‰¾åˆ° <code>AService</code> ä»»åŠ¡é“¾ä¹‹å‰çš„æ‰€æœ‰ä»»åŠ¡ å›è°ƒ<code>rollback</code> æ–¹æ³•
```java 
@Task(callback = true)
public class AService extend AsyncTask<Object,Object>{
 // ...
}
```


## ä»»åŠ¡å¼‚å¸¸æ˜¯å¦ä¸­æ–­å­ä»»åŠ¡æµç¨‹
åœ¨æ‰§è¡Œ A->B->C è¿‡ç¨‹ä¸­ï¼Œå¦‚æœA æ‰§è¡Œå¼‚å¸¸ï¼Œ**Gobrs-Async** é»˜è®¤ä¸ä¼šç»§ç»­æ‰§è¡Œ Bã€Cä»»åŠ¡äº†ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨è€…æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œ æƒ³è¦ç»§ç»­æ‰§è¡Œ Bã€Cä»»åŠ¡ï¼Œ
è¿™ç§æƒ…å†µ**Gobrs-Async** ä¹Ÿæä¾›æ”¯æŒ, åªéœ€è¦åœ¨ <code>Task</code>æ³¨è§£ä¸­å£°æ˜ <code>failSubExec</code> å³å¯ç»§ç»­æ‰§è¡Œä»»åŠ¡æµç¨‹ã€‚
```java  
@Service
@Task(failSubExec = true)
public class BService extends AsyncTask<Object, Object>  {
// ...
}
```


